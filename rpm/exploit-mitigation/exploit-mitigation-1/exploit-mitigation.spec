Name:		exploit-mitigation
Version:	1
Release:	5%{?dist}
Summary:	FGI exploit mitigation package

Group:		system/security
License:	GPL
URL:		http://pulse.fgi.csc.fi/
Source0:	exploit-mitigation-%{version}.tar.gz
BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
#BuildArch:	noarch

Requires:	systemtap-client , systemtap-runtime

%description
FGI exploit mitigation package

%prep
%setup -q


%build
%configure
#make %{?_smp_mflags}


%install
rm -rf %{buildroot}
#make install DESTDIR=%{buildroot}
mkdir -p %{buildroot}/usr/share/systemtap/tapset/fgi/2.6.32-358.0.1.el6.x86_64 
mkdir -p %{buildroot}/usr/share/systemtap/tapset/fgi/2.6.32-358.2.1.el6.x86_64
mkdir -p %{buildroot}/usr/share/systemtap/tapset/fgi/2.6.32-358.6.1.el6.x86_64
mkdir -p %{buildroot}/etc/init.d/

cp mitigation1.stp %{buildroot}/usr/share/systemtap/tapset/fgi
cp exploit-mitigation %{buildroot}/etc/init.d/
for a in 2.6.32-358.0.1.el6.x86_64 2.6.32-358.2.1.el6.x86_64 2.6.32-358.6.1.el6.x86_64; do
	cp mitigation1-$a.ko %{buildroot}/usr/share/systemtap/tapset/fgi/$a
done



%clean
rm -rf %{buildroot}


%files
%defattr(-,root,root,-)
/etc/init.d/exploit-mitigation
/usr/share/systemtap/tapset/fgi/*
%doc

%post
/sbin/chkconfig --add exploit-mitigation
/sbin/chkconfig exploit-mitigation on
service exploit-mitigation start

%preun
/sbin/chkconfig --del exploit-mitigation


%changelog
* Wed May 15 2013 Ulf Tigerstedt <ulf.tigerstedt@csc.fi> 1-5
  - Provides precompiled modules

* Wed May 15 2013 Ulf Tigerstedt <ulf.tigerstedt@csc.fi> 1-4
  - Fixed the stap call to make it background

* Wed May 15 2013 Ulf Tigerstedt <ulf.tigerstedt@csc.fi> 1-3
  - Added systemtap-devel

* Wed May 15 2013 Ulf Tigerstedt <ulf.tigerstedt@csc.fi> 1-2
  - Added debuginfo install

* Wed May 15 2013 Ulf Tigerstedt <ulf.tigerstedt@csc.fi> 1-1
  - First release with one exploit mitigated

